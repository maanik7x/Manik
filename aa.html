<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 Habit Tracker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; margin: 0; 
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col overflow-hidden">

    <!-- HEADER -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm flex-none">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                
                <!-- Title & Date Range -->
                <div>
                    <h1 class="text-2xl font-bold text-indigo-900 flex items-center gap-2">
                        <i data-lucide="calendar" class="w-6 h-6 text-indigo-600"></i>
                        2026 Habit Tracker
                    </h1>
                    <p class="text-sm text-slate-500 mt-1">Jan 19, 2026 â€” Jul 18, 2026</p>
                </div>

                <!-- Controls -->
                <div class="flex items-center gap-4">
                    <!-- Today Date -->
                    <div class="hidden sm:block text-right mr-2">
                        <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Today</div>
                        <div id="header-date-display" class="text-sm font-bold text-slate-700">--</div>
                    </div>

                    <!-- View Switcher -->
                    <div class="flex bg-slate-100 p-1 rounded-lg border border-slate-200">
                        <button onclick="setViewMode('daily')" id="btn-daily" class="px-3 py-1.5 rounded-md text-sm font-medium flex items-center gap-2 transition-all">
                            <i data-lucide="layout-grid" class="w-4 h-4"></i> Daily
                        </button>
                        <button onclick="setViewMode('weekly')" id="btn-weekly" class="px-3 py-1.5 rounded-md text-sm font-medium flex items-center gap-2 transition-all">
                            <i data-lucide="list" class="w-4 h-4"></i> Weekly
                        </button>
                        <button onclick="setViewMode('analytics')" id="btn-analytics" class="px-3 py-1.5 rounded-md text-sm font-medium flex items-center gap-2 transition-all">
                            <i data-lucide="bar-chart-3" class="w-4 h-4"></i> Analytics
                        </button>
                    </div>

                    <!-- Total Stats -->
                    <div class="hidden md:flex items-center gap-3 bg-indigo-50 px-4 py-2 rounded-lg border border-indigo-100">
                        <div class="flex flex-col items-end">
                            <span class="text-[10px] font-bold text-indigo-400 uppercase tracking-wider">Total</span>
                            <span id="header-total-progress" class="text-lg font-bold text-indigo-900 leading-none">0%</span>
                        </div>
                        <i data-lucide="trophy" id="header-trophy-icon" class="w-5 h-5 text-indigo-300"></i>
                    </div>
                </div>
            </div>

            <!-- Add Habit Input (Only visible in Daily view) -->
            <div id="add-habit-container" class="mt-4 hidden gap-2 max-w-md">
                <input type="text" id="new-habit-input" placeholder="Add a new habit..." 
                    class="flex-1 px-4 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm"
                    onkeypress="if(event.key === 'Enter') addHabit()">
                <button onclick="addHabit()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 active:bg-indigo-800 transition-colors flex items-center gap-2 text-sm font-medium">
                    <i data-lucide="plus" class="w-4 h-4"></i> Add
                </button>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT AREA -->
    <main id="app-content" class="flex-1 overflow-hidden flex flex-col bg-slate-50 relative">
        <!-- Content injected via JS -->
    </main>

    <!-- FOOTER -->
    <footer class="bg-white border-t border-slate-200 py-3 px-6 text-xs text-slate-500 flex flex-col sm:flex-row justify-between items-center gap-4 flex-none">
        <div id="footer-legend" class="flex gap-4">
            <!-- Dynamic Legend -->
        </div>
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-1 text-emerald-600 bg-emerald-50 px-2 py-1 rounded">
                <i data-lucide="save" class="w-3 h-3"></i>
                <span id="last-saved-time" class="font-medium">Auto-save active</span>
            </div>
            <div class="h-4 w-px bg-slate-200 mx-2"></div>
            <button onclick="exportData()" class="flex items-center gap-1 hover:text-indigo-600 transition-colors">
                <i data-lucide="download" class="w-4 h-4"></i> <span class="hidden sm:inline">Export</span>
            </button>
            <button onclick="document.getElementById('import-file').click()" class="flex items-center gap-1 hover:text-indigo-600 transition-colors">
                <i data-lucide="upload" class="w-4 h-4"></i> <span class="hidden sm:inline">Import</span>
            </button>
            <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(this)">
        </div>
    </footer>

    <!-- DELETE MODAL -->
    <div id="delete-modal" class="hidden absolute inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-xl max-w-sm w-full p-6">
            <div class="flex items-center gap-3 text-red-600 mb-4">
                <div class="p-2 bg-red-100 rounded-full"><i data-lucide="alert-circle" class="w-6 h-6"></i></div>
                <h3 class="text-lg font-bold text-slate-900">Delete Habit?</h3>
            </div>
            <p class="text-slate-600 mb-6">Are you sure you want to delete <strong id="delete-habit-name">...</strong>? <br/><br/><span class="text-xs text-red-500 font-medium bg-red-50 p-2 rounded block">Warning: All progress history for this habit will be permanently lost.</span></p>
            <div class="flex gap-3 justify-end">
                <button onclick="closeDeleteModal()" class="px-4 py-2 text-slate-600 font-medium hover:bg-slate-100 rounded-lg transition-colors">Cancel</button>
                <button onclick="confirmDeleteHabit()" class="px-4 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition-colors shadow-sm">Delete Habit</button>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- CONSTANTS & CONFIG ---
        const START_DATE = new Date('2026-01-19T00:00:00');
        const END_DATE = new Date('2026-07-18T00:00:00');
        const CHART_COLORS = ['#6366f1', '#10b981', '#f59e0b', '#ec4899', '#8b5cf6', '#06b6d4', '#f43f5e', '#84cc16'];

        // --- STATE MANAGEMENT ---
        const state = {
            habits: [],
            records: {},
            goals: {},
            viewMode: 'daily',
            habitToDeleteId: null,
            currentDate: new Date(),
            dates: [],
            months: [],
            weeks: []
        };

        // --- INITIALIZATION ---
        function init() {
            // Load Data
            try {
                const savedHabits = localStorage.getItem('habitTracker_habits');
                state.habits = savedHabits ? JSON.parse(savedHabits) : [
                    { id: 'h1', name: 'Morning Exercise' },
                    { id: 'h2', name: 'Read 30 mins' },
                    { id: 'h3', name: 'Drink 2L Water' }
                ];

                const savedRecords = localStorage.getItem('habitTracker_records');
                state.records = savedRecords ? JSON.parse(savedRecords) : {};

                const savedGoals = localStorage.getItem('habitTracker_goals');
                state.goals = savedGoals ? JSON.parse(savedGoals) : {};
            } catch (e) {
                console.error("Error loading local storage", e);
            }

            // Generate Calendar Data
            generateCalendarData();

            // Start Clock
            updateClock();
            setInterval(updateClock, 60000);

            // Initial Render
            render();
        }

        function generateCalendarData() {
            state.dates = [];
            let current = new Date(START_DATE);
            while (current <= END_DATE) {
                state.dates.push(new Date(current));
                current.setDate(current.getDate() + 1);
            }

            // Group by Month
            state.months = [];
            let currentMonth = -1;
            state.dates.forEach((date, index) => {
                if (date.getMonth() !== currentMonth) {
                    state.months.push({
                        name: date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }),
                        key: getMonthKey(date),
                        days: []
                    });
                    currentMonth = date.getMonth();
                }
                state.months[state.months.length - 1].days.push(date);
            });

            // Group by Week
            state.weeks = [];
            let currentWeek = [];
            state.dates.forEach((date, index) => {
                currentWeek.push(date);
                if (date.getDay() === 0 || index === state.dates.length - 1) {
                    state.weeks.push(currentWeek);
                    currentWeek = [];
                }
            });
        }

        // --- HELPERS ---
        const formatDateKey = (date) => {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        };
        const getMonthKey = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        const updateClock = () => {
            state.currentDate = new Date();
            const dateStr = state.currentDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
            document.getElementById('header-date-display').innerText = dateStr;
        };
        
        // --- PERSISTENCE ---
        function saveData() {
            localStorage.setItem('habitTracker_habits', JSON.stringify(state.habits));
            localStorage.setItem('habitTracker_records', JSON.stringify(state.records));
            localStorage.setItem('habitTracker_goals', JSON.stringify(state.goals));
            
            const timeStr = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            document.getElementById('last-saved-time').innerText = `Saved ${timeStr}`;
        }

        // --- ACTIONS ---
        function setViewMode(mode) {
            state.viewMode = mode;
            render();
        }

        function addHabit() {
            const input = document.getElementById('new-habit-input');
            const name = input.value.trim();
            if (!name) return;

            const newId = 'h-' + Date.now().toString(36) + Math.random().toString(36).substr(2);
            state.habits.push({ id: newId, name: name });
            input.value = '';
            
            saveData();
            render();
        }

        function toggleHabit(dateKey, habitId) {
            const todayKey = formatDateKey(state.currentDate);
            
            // Only allow editing today
            if (dateKey !== todayKey) return;

            if (!state.records[dateKey]) state.records[dateKey] = {};
            
            if (state.records[dateKey][habitId]) {
                delete state.records[dateKey][habitId];
            } else {
                state.records[dateKey][habitId] = true;
            }

            saveData();
            
            // Optimization: Just re-render the clicked cell and related stats if needed, 
            // but for simplicity we re-render the view, preserving scroll position is handled in renderDailyView.
            render();
        }

        function promptDelete(habitId) {
            const habit = state.habits.find(h => h.id === habitId);
            if (!habit) return;
            state.habitToDeleteId = habitId;
            document.getElementById('delete-habit-name').innerText = habit.name;
            document.getElementById('delete-modal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            state.habitToDeleteId = null;
            document.getElementById('delete-modal').classList.add('hidden');
        }

        function confirmDeleteHabit() {
            if (!state.habitToDeleteId) return;
            
            const id = state.habitToDeleteId;
            state.habits = state.habits.filter(h => h.id !== id);
            
            // Cleanup records
            Object.keys(state.records).forEach(key => {
                if (state.records[key][id]) delete state.records[key][id];
            });

            // Cleanup goals
            Object.keys(state.goals).forEach(key => {
                if (state.goals[key][id]) delete state.goals[key][id];
            });

            saveData();
            closeDeleteModal();
            render();
        }

        function updateGoal(monthKey, habitId, value) {
            if (!state.goals[monthKey]) state.goals[monthKey] = {};
            state.goals[monthKey][habitId] = parseInt(value) || 0;
            saveData();
            render(); // Re-render to update the bar graph
        }

        function exportData() {
            const data = { 
                habits: state.habits, 
                records: state.records, 
                goals: state.goals, 
                exportDate: new Date().toISOString(), 
                appVersion: '2026-tracker-vanilla' 
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `habit-tracker-backup-${formatDateKey(new Date())}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.habits && data.records) {
                        state.habits = data.habits;
                        state.records = data.records;
                        if (data.goals) state.goals = data.goals;
                        saveData();
                        render();
                    }
                } catch (err) {
                    alert('Invalid file format');
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        // --- STATS CALCULATIONS ---
        function calculateStats() {
            let totalPossible = state.habits.length * state.dates.length;
            let totalCompleted = 0;
            const habitStats = {};
            state.habits.forEach(h => habitStats[h.id] = { completed: 0 });

            state.dates.forEach(date => {
                const key = formatDateKey(date);
                const dayRecord = state.records[key] || {};
                state.habits.forEach(h => {
                    if (dayRecord[h.id]) {
                        totalCompleted++;
                        habitStats[h.id].completed++;
                    }
                });
            });

            const overallProgress = totalPossible === 0 ? 0 : Math.round((totalCompleted / totalPossible) * 100);
            return { totalCompleted, totalPossible, overallProgress, habitStats };
        }

        // --- RENDER FUNCTIONS ---
        function render() {
            // Update Header State
            const stats = calculateStats();
            document.getElementById('header-total-progress').innerText = `${stats.overallProgress}%`;
            
            const trophyIcon = document.getElementById('header-trophy-icon');
            trophyIcon.className = `w-5 h-5 ${stats.overallProgress > 80 ? 'text-yellow-500' : 'text-indigo-300'}`;

            // Update Header Buttons
            ['daily', 'weekly', 'analytics'].forEach(mode => {
                const btn = document.getElementById(`btn-${mode}`);
                if (state.viewMode === mode) {
                    btn.className = "px-3 py-1.5 rounded-md text-sm font-medium flex items-center gap-2 transition-all bg-white text-indigo-600 shadow-sm";
                } else {
                    btn.className = "px-3 py-1.5 rounded-md text-sm font-medium flex items-center gap-2 transition-all text-slate-500 hover:text-slate-700";
                }
            });

            // Update Visibility of Add Button
            document.getElementById('add-habit-container').className = state.viewMode === 'daily' ? 'mt-4 flex gap-2 max-w-md' : 'hidden';

            // Render Content
            const content = document.getElementById('app-content');
            if (state.viewMode === 'daily') renderDailyView(content, stats);
            else if (state.viewMode === 'weekly') renderWeeklyView(content);
            else renderAnalyticsView(content, stats);
            
            renderFooter();
            lucide.createIcons();
        }

        function renderDailyView(container, stats) {
            // Preserve scroll position if re-rendering daily view
            const scrollContainer = document.getElementById('daily-scroll-container');
            const scrollPos = scrollContainer ? scrollContainer.scrollLeft : 0;

            const todayKey = formatDateKey(state.currentDate);

            let habitsHtml = state.habits.map(habit => {
                const completed = stats.habitStats[habit.id].completed;
                const progress = Math.round((completed / state.dates.length) * 100);
                return `
                    <div class="h-16 px-4 flex flex-col justify-center group relative hover:bg-slate-50 transition-colors border-b border-slate-100 last:border-0">
                        <div class="flex items-center justify-between mb-1">
                            <span class="font-medium text-slate-700 truncate pr-2 w-32" title="${habit.name}">${habit.name}</span>
                            <button onclick="promptDelete('${habit.id}')" class="opacity-100 md:opacity-0 md:group-hover:opacity-100 text-slate-400 hover:text-red-500 transition-opacity p-1">
                                <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                            </button>
                        </div>
                        <div class="w-full h-1 bg-slate-100 rounded-full overflow-hidden">
                            <div class="h-full bg-emerald-500 rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                        </div>
                        <span class="text-[10px] text-slate-400 mt-0.5 text-right">${progress}%</span>
                    </div>
                `;
            }).join('') || `<div class="h-32 flex items-center justify-center px-4 text-center text-slate-400 text-sm italic">Add a habit to start tracking!</div>`;

            // Month Header
            const monthHeaderHtml = state.months.map(m => 
                `<div class="h-8 flex items-center px-4 text-xs font-bold text-indigo-600 bg-indigo-50/50 border-r border-indigo-100 whitespace-nowrap sticky top-0" style="width: ${m.days.length * 48}px">${m.name}</div>`
            ).join('');

            // Days Header
            const daysHeaderHtml = state.dates.map(date => {
                const key = formatDateKey(date);
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                const isToday = key === todayKey;
                
                // Day Progress
                const dayRecord = state.records[key] || {};
                const checkedCount = state.habits.filter(h => dayRecord[h.id]).length;
                const dailyProgress = state.habits.length > 0 ? (checkedCount / state.habits.length) : 0;

                return `
                    <div class="w-12 flex flex-col justify-end items-center pb-2 border-r border-slate-100 ${isWeekend ? 'bg-slate-50' : 'bg-white'} ${isToday ? 'bg-indigo-50/30' : ''}">
                        <div class="mb-2 w-1.5 bg-slate-200 rounded-full h-8 flex items-end overflow-hidden">
                            <div class="w-full rounded-full transition-all duration-300 ${dailyProgress === 1 ? 'bg-emerald-500' : 'bg-indigo-500'}" style="height: ${dailyProgress * 100}%"></div>
                        </div>
                        <span class="text-[10px] uppercase font-bold ${isToday ? 'text-indigo-600' : 'text-slate-400'}">${date.toLocaleDateString('en-US', { weekday: 'short' })}</span>
                        <span class="text-xs font-medium ${dailyProgress === 1 ? 'text-emerald-600 font-bold' : isToday ? 'text-indigo-700 font-bold' : 'text-slate-600'}">${date.getDate()}</span>
                    </div>
                `;
            }).join('');

            // Grid
            const gridRowsHtml = state.habits.map(habit => {
                const cells = state.dates.map(date => {
                    const key = formatDateKey(date);
                    const isCompleted = state.records[key]?.[habit.id];
                    const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                    const isToday = key === todayKey;
                    
                    const btnClass = !isToday 
                        ? 'opacity-30 cursor-not-allowed bg-slate-100 text-transparent' 
                        : (isCompleted 
                            ? 'bg-indigo-600 text-white shadow-sm shadow-indigo-200 cursor-pointer hover:scale-110 active:scale-95' 
                            : 'bg-slate-100 text-transparent hover:bg-slate-200 cursor-pointer hover:scale-110 active:scale-95');

                    // If completed on past day, show color but no interaction
                    const displayClass = (!isToday && isCompleted) 
                        ? 'bg-indigo-600 text-white opacity-40 cursor-not-allowed' 
                        : btnClass;

                    return `
                        <div class="w-12 border-r border-slate-100 flex items-center justify-center relative group ${isWeekend ? 'bg-slate-50/50' : 'bg-white'} ${isToday ? 'bg-indigo-50/10' : ''} transition-colors hover:bg-indigo-50/50">
                            <button onclick="toggleHabit('${key}', '${habit.id}')" 
                                title="${isToday ? 'Toggle habit' : 'You can only edit habits for today'}"
                                class="w-8 h-8 rounded-lg flex items-center justify-center transition-all duration-200 ${displayClass}">
                                <i data-lucide="check" class="w-5 h-5 ${isCompleted ? 'stroke-[3px]' : ''}"></i>
                            </button>
                        </div>
                    `;
                }).join('');
                return `<div class="h-16 flex border-b border-slate-100 last:border-0">${cells}</div>`;
            }).join('');

            container.innerHTML = `
                <div id="daily-scroll-container" class="flex-1 overflow-auto relative flex">
                    <!-- Sticky Sidebar -->
                    <div class="sticky left-0 z-20 bg-white border-r border-slate-200 shadow-[4px_0_24px_rgba(0,0,0,0.02)] min-w-[220px] max-w-[220px]">
                        <div class="h-[98px] border-b border-slate-100 bg-slate-50 flex items-end pb-2 px-4">
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Habits</span>
                        </div>
                        <div class="divide-y divide-slate-100">
                            ${habitsHtml}
                        </div>
                    </div>
                    
                    <!-- Timeline -->
                    <div class="flex flex-col min-w-max">
                         <div class="h-[98px] flex flex-col border-b border-slate-100 bg-slate-50">
                            <div class="flex border-b border-slate-200/50">${monthHeaderHtml}</div>
                            <div class="flex flex-1">${daysHeaderHtml}</div>
                         </div>
                         <div class="divide-y divide-slate-100">
                            ${gridRowsHtml}
                         </div>
                    </div>
                </div>
            `;
            
            // Restore scroll
            setTimeout(() => {
                const el = document.getElementById('daily-scroll-container');
                if(el) el.scrollLeft = scrollPos;
            }, 0);
        }

        function renderWeeklyView(container) {
            const weeksHtml = state.weeks.map((week, index) => {
                const startDate = week[0];
                const endDate = week[week.length - 1];
                let possible = state.habits.length * week.length;
                let completed = 0;
                
                const habitStats = {};
                state.habits.forEach(h => habitStats[h.id] = 0);

                week.forEach(date => {
                    const key = formatDateKey(date);
                    const rec = state.records[key] || {};
                    state.habits.forEach(h => {
                        if(rec[h.id]) { completed++; habitStats[h.id]++; }
                    });
                });

                const percent = possible === 0 ? 0 : Math.round((completed / possible) * 100);
                
                // Find strongest habit
                let bestHabit = null; let max = -1;
                state.habits.forEach(h => {
                    if(habitStats[h.id] > max) { max = habitStats[h.id]; bestHabit = h; }
                });

                const colorClass = percent === 100 ? 'emerald' : percent >= 80 ? 'indigo' : 'slate';
                const bgClass = `bg-${colorClass}-500`;
                const textClass = `text-${colorClass}-700`;
                const bgLightClass = `bg-${colorClass}-100`;

                return `
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-5 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Week ${index + 1}</span>
                                <h3 class="font-semibold text-slate-800">${startDate.toLocaleDateString(undefined, {month:'short', day:'numeric'})} - ${endDate.toLocaleDateString(undefined, {month:'short', day:'numeric'})}</h3>
                            </div>
                            <div class="px-2 py-1 rounded text-xs font-bold ${bgLightClass} ${textClass}">${percent}%</div>
                        </div>
                        <div class="w-full h-2 bg-slate-100 rounded-full mb-6 overflow-hidden">
                            <div class="h-full rounded-full ${bgClass}" style="width: ${percent}%"></div>
                        </div>
                        ${bestHabit && max > 0 ? `
                        <div class="flex items-start gap-3">
                            <div class="mt-0.5 w-6 h-6 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-600 shrink-0"><i data-lucide="arrow-up-right" class="w-3.5 h-3.5"></i></div>
                            <div>
                                <p class="text-xs font-bold text-slate-400 uppercase">Strongest Habit</p>
                                <p class="text-sm font-medium text-slate-700">${bestHabit.name}</p>
                                <p class="text-xs text-slate-500">${max} / ${week.length} days</p>
                            </div>
                        </div>` : `<p class="text-xs text-slate-400 italic">No activity.</p>`}
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div class="flex-1 overflow-y-auto p-4 md:p-8">
                    <div class="max-w-5xl mx-auto space-y-6">
                        <div class="flex items-center justify-between mb-2">
                            <h2 class="text-xl font-bold text-slate-800">Weekly Review</h2>
                            <div class="text-sm text-slate-500">${state.weeks.length} Weeks</div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${weeksHtml}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAnalyticsView(container, stats) {
            // --- ACHIEVEMENTS ---
            const achievements = [];
            if (stats.totalCompleted > 0) achievements.push({ title: 'First Step', desc: 'Completed first habit', icon: 'star', bg: 'bg-yellow-100 text-yellow-500' });
            
            const hasMetGoal = state.months.some(m => state.habits.some(h => {
                const goal = state.goals[m.key]?.[h.id] || 0;
                if(goal===0) return false;
                let act = 0; m.days.forEach(d => { if(state.records[formatDateKey(d)]?.[h.id]) act++ });
                return act >= goal;
            }));
            if(hasMetGoal) achievements.push({ title: 'Goal Crusher', desc: 'Met a monthly goal', icon: 'target', bg: 'bg-red-100 text-red-500' });

            if(stats.overallProgress >= 50) achievements.push({ title: 'Halfway There', desc: '50% completion', icon: 'trending-up', bg: 'bg-indigo-100 text-indigo-500' });

            const weekendWarrior = state.dates.some(d => (d.getDay()===0||d.getDay()===6) && state.habits.some(h => state.records[formatDateKey(d)]?.[h.id]));
            if(weekendWarrior) achievements.push({ title: 'Weekend Warrior', desc: 'Active on weekends', icon: 'award', bg: 'bg-purple-100 text-purple-500' });

            const perfectWeek = state.weeks.some(w => w.every(d => state.habits.every(h => state.records[formatDateKey(d)]?.[h.id])));
            if(perfectWeek) achievements.push({ title: 'Perfectionist', desc: '100% week completion', icon: 'trophy', bg: 'bg-emerald-100 text-emerald-500' });

            // --- LEADERBOARD & PIE ---
            const sortedHabits = [...state.habits].map(h => {
                const count = stats.habitStats[h.id].completed;
                return { ...h, count, percent: state.dates.length>0 ? Math.round((count/state.dates.length)*100) : 0 };
            }).sort((a,b) => b.count - a.count);

            // Pie Data
            let currentPiePos = 0;
            const pieSegments = sortedHabits.filter(h=>h.count>0).map((h, i) => {
                const share = (h.count / stats.totalCompleted) * 100;
                const color = CHART_COLORS[i % CHART_COLORS.length];
                const segment = `${color} ${currentPiePos.toFixed(1)}% ${(currentPiePos + share).toFixed(1)}%`;
                currentPiePos += share;
                return { ...h, color, share };
            });
            const pieGradient = stats.totalCompleted === 0 ? 'conic-gradient(#f1f5f9 0% 100%)' : `conic-gradient(${pieSegments.map(s => `${s.color} 0 ${s.share}%`).join(', ')})`;
            // Note: Simple CSS conic gradients don't support start/end stops nicely in one string list without calc, 
            // easier approach: use simple stops.
            const pieStyle = stats.totalCompleted === 0 
                ? 'background: #f1f5f9' 
                : `background: conic-gradient(${pieSegments.map((s,i,arr) => {
                    const prevEnd = arr.slice(0,i).reduce((acc, curr) => acc + curr.share, 0);
                    return `${s.color} ${prevEnd}% ${prevEnd + s.share}%`;
                }).join(', ')})`;


            // --- LINE CHART (SVG) ---
            const trendData = state.weeks.map((week, i) => {
                let p = state.habits.length * week.length;
                let c = 0;
                week.forEach(d => {
                    const rec = state.records[formatDateKey(d)]||{};
                    state.habits.forEach(h=>{if(rec[h.id]) c++});
                });
                return { label: `W${i+1}`, val: p===0?0:Math.round((c/p)*100) };
            });

            const makePath = (data, close) => {
                if(data.length < 2) return '';
                const width = 1000, height = 200;
                const points = data.map((d, i) => {
                    const x = (i / (data.length - 1)) * width;
                    const y = height - (d.val / 100) * height;
                    return `${x},${y}`;
                }).join(' ');
                return close ? `${points} ${width},${height} 0,${height}` : points;
            };

            // --- RENDER HTML ---
            const badgesHtml = achievements.map(a => `
                <div class="flex flex-col items-center text-center p-4 rounded-xl border border-slate-100 bg-slate-50/50">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center mb-3 ${a.bg}"><i data-lucide="${a.icon}" class="w-6 h-6"></i></div>
                    <h4 class="font-bold text-slate-800 text-sm">${a.title}</h4>
                    <p class="text-xs text-slate-500 leading-tight mt-1">${a.desc}</p>
                </div>
            `).join('') || '<div class="col-span-full py-8 text-center text-slate-400 italic text-sm">Complete habits to unlock badges!</div>';

            const leaderboardHtml = sortedHabits.map((h, i) => `
                <div class="flex items-center gap-4 p-3 rounded-xl bg-slate-50/50 border border-slate-100 hover:border-indigo-100 transition-colors">
                    <div class="w-8 h-8 flex items-center justify-center rounded-full font-bold text-sm shadow-sm ${i===0?'bg-yellow-100 text-yellow-700':i===1?'bg-slate-200 text-slate-700':i===2?'bg-orange-100 text-orange-800':'bg-white text-slate-500'}">${i+1}</div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between mb-1.5">
                            <span class="font-semibold text-slate-700 truncate pr-2 text-sm">${h.name}</span>
                            <span class="font-bold text-indigo-600 text-xs">${h.percent}%</span>
                        </div>
                        <div class="w-full h-1.5 bg-slate-200 rounded-full overflow-hidden">
                            <div class="h-full rounded-full ${i<3?'bg-indigo-500':'bg-slate-400'}" style="width: ${h.percent}%"></div>
                        </div>
                    </div>
                </div>
            `).join('');

            const pieLegendHtml = pieSegments.map(s => `
                <div class="flex items-center gap-2 text-sm">
                    <div class="w-3 h-3 rounded-full" style="background: ${s.color}"></div>
                    <span class="font-medium text-slate-700 truncate max-w-[120px]">${s.name}</span>
                    <span class="text-slate-400 ml-auto">${s.share.toFixed(0)}%</span>
                </div>
            `).join('') || '<div class="text-slate-400 italic text-center">No data yet.</div>';

            // Goals Section
            const goalsHtml = state.months.map(m => {
                const rows = state.habits.map(h => {
                    const goal = state.goals[m.key]?.[h.id] || 0;
                    let actual = 0;
                    m.days.forEach(d => { if(state.records[formatDateKey(d)]?.[h.id]) actual++ });
                    const barWidth = (actual / m.days.length) * 100;
                    const goalLeft = (goal / m.days.length) * 100;
                    
                    return `
                        <div class="flex flex-col md:flex-row md:items-center gap-4">
                            <div class="w-full md:w-48 shrink-0">
                                <div class="font-medium text-slate-700 text-sm truncate mb-1">${h.name}</div>
                                <div class="flex items-center gap-2 text-xs">
                                    <label class="text-slate-400">Goal:</label>
                                    <input type="number" min="0" max="${m.days.length}" value="${goal === 0 ? '' : goal}" 
                                        onchange="updateGoal('${m.key}', '${h.id}', this.value)" placeholder="Set"
                                        class="w-12 border border-slate-200 rounded px-1 py-0.5 text-center focus:border-indigo-500 focus:outline-none">
                                    <span class="text-slate-400">/ ${m.days.length} days</span>
                                </div>
                            </div>
                            <div class="flex-1 h-8 bg-slate-100 rounded-lg relative overflow-hidden flex items-center">
                                ${goal > 0 ? `<div class="absolute top-0 bottom-0 border-r-2 border-slate-400 border-dashed z-10 opacity-50" style="left: ${goalLeft}%"></div>` : ''}
                                <div class="h-full transition-all duration-500 flex items-center justify-end pr-2 text-[10px] font-bold text-white ${actual>=goal && goal>0 ? 'bg-emerald-500':'bg-indigo-500'}" style="width: ${barWidth}%">
                                    ${actual > 0 ? actual : ''}
                                </div>
                                ${goal > 0 ? `<div class="absolute text-[9px] font-bold text-slate-500 top-0.5" style="left: min(${goalLeft}%, 90%)">Goal: ${goal}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('<div class="h-4"></div>'); // Spacer
                return `
                    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden mb-6">
                        <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex items-center justify-between">
                            <h3 class="font-bold text-slate-800 flex items-center gap-2"><i data-lucide="calendar" class="w-4 h-4 text-indigo-500"></i> ${m.name}</h3>
                            <span class="text-xs font-semibold text-slate-400 bg-white border border-slate-200 px-2 py-1 rounded">${m.days.length} Days</span>
                        </div>
                        <div class="p-6">${rows}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div class="flex-1 overflow-y-auto p-4 md:p-8 bg-slate-50">
                    <div class="max-w-6xl mx-auto space-y-8">
                        
                        <!-- Badges -->
                        <section class="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="p-2 bg-yellow-100 rounded-lg text-yellow-600"><i data-lucide="trophy" class="w-6 h-6"></i></div>
                                <div><h2 class="text-xl font-bold text-slate-900">Achievements</h2><p class="text-sm text-slate-500">Unlocked: ${achievements.length} badges</p></div>
                            </div>
                            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">${badgesHtml}</div>
                        </section>

                        <!-- Leaderboard & Pie -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <section class="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm flex flex-col">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="p-2 bg-indigo-100 rounded-lg text-indigo-600"><i data-lucide="medal" class="w-6 h-6"></i></div>
                                    <div><h2 class="text-xl font-bold text-slate-900">Leaderboard</h2><p class="text-sm text-slate-500">Most consistent habits</p></div>
                                </div>
                                <div class="space-y-4 flex-1">${leaderboardHtml}</div>
                            </section>

                            <section class="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm flex flex-col">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="p-2 bg-emerald-100 rounded-lg text-emerald-600"><i data-lucide="pie-chart" class="w-6 h-6"></i></div>
                                    <div><h2 class="text-xl font-bold text-slate-900">Distribution</h2><p class="text-sm text-slate-500">Share of completed habits</p></div>
                                </div>
                                <div class="flex-1 flex flex-col sm:flex-row items-center justify-center gap-8">
                                    <div class="relative w-48 h-48 rounded-full shrink-0 shadow-inner" style="${pieStyle}">
                                        <div class="absolute inset-0 rounded-full border border-slate-100/50"></div>
                                    </div>
                                    <div class="flex flex-col gap-2 w-full sm:w-auto">${pieLegendHtml}</div>
                                </div>
                            </section>
                        </div>

                        <!-- Weekly Trend SVG -->
                        <section class="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="p-2 bg-blue-100 rounded-lg text-blue-600"><i data-lucide="line-chart" class="w-6 h-6"></i></div>
                                <div><h2 class="text-xl font-bold text-slate-900">Trend</h2><p class="text-sm text-slate-500">Weekly consistency</p></div>
                            </div>
                            <div class="h-64 w-full bg-slate-50/50 rounded-xl border border-slate-100 relative p-4 overflow-hidden">
                                ${trendData.length > 1 ? `
                                <svg viewBox="0 0 1000 200" preserveAspectRatio="none" class="absolute left-10 right-4 top-[10%] bottom-[10%] w-[calc(100%-3.5rem)] h-[80%] overflow-visible">
                                    <defs>
                                        <linearGradient id="grad" x1="0" y1="0" x2="0" y2="1">
                                            <stop offset="0%" stop-color="#6366f1" stop-opacity="0.4" />
                                            <stop offset="100%" stop-color="#6366f1" stop-opacity="0" />
                                        </linearGradient>
                                    </defs>
                                    <path d="${makePath(trendData, true)}" fill="url(#grad)" />
                                    <path d="${makePath(trendData, false)}" fill="none" stroke="#6366f1" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
                                    ${trendData.map((d,i) => {
                                        const x = (i/(trendData.length-1))*1000;
                                        const y = 200 - (d.val/100)*200;
                                        return `<circle cx="${x}" cy="${y}" r="4" class="fill-white stroke-indigo-600 stroke-[3px] hover:r-6 transition-all cursor-pointer"><title>${d.val}% (Week ${i+1})</title></circle>`;
                                    }).join('')}
                                </svg>
                                ` : '<div class="absolute inset-0 flex items-center justify-center text-slate-400 italic">Need more data</div>'}
                            </div>
                        </section>

                        <!-- Monthly Goals -->
                        <div>
                            ${goalsHtml}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderFooter() {
            const legend = document.getElementById('footer-legend');
            if(state.viewMode === 'daily') {
                legend.innerHTML = `
                    <div class="flex items-center gap-2"><div class="w-3 h-3 rounded bg-indigo-600"></div><span>Completed</span></div>
                    <div class="flex items-center gap-2"><div class="w-3 h-3 rounded bg-slate-100 border border-slate-200"></div><span>Pending</span></div>
                `;
            } else if (state.viewMode === 'analytics') {
                legend.innerHTML = `<span>Set goals to track your growth</span>`;
            } else {
                legend.innerHTML = `<span>Review your weekly progress</span>`;
            }
        }

        // --- START APP ---
        window.onload = init;
    </script>
</body>
</html>